<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClusterWrapperBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.beans</a> &gt; <span class="el_source">ClusterWrapperBean.java</span></div><h1>ClusterWrapperBean.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.beans;

import java.lang.management.ManagementFactory;
import java.util.Set;
import javax.management.MBeanServer;
import javax.management.ObjectInstance;
import javax.management.ObjectName;
import psiprobe.model.jmx.AsyncClusterSender;
import psiprobe.model.jmx.Cluster;
import psiprobe.model.jmx.ClusterSender;
import psiprobe.model.jmx.PooledClusterSender;
import psiprobe.model.jmx.SyncClusterSender;
import psiprobe.tools.JmxTools;

/**
 * The Class ClusterWrapperBean.
 */
<span class="fc" id="L28">public class ClusterWrapperBean {</span>

  /**
   * Gets the cluster.
   *
   * @param serverName the server name
   * @param hostName the host name
   * @param loadMembers the load members
   * @return the cluster
   * @throws Exception the exception
   */
  public Cluster getCluster(String serverName, String hostName, boolean loadMembers)
      throws Exception {

<span class="nc" id="L42">    Cluster cluster = null;</span>

<span class="nc" id="L44">    MBeanServer mbeanServer = ManagementFactory.getPlatformMBeanServer();</span>
<span class="nc" id="L45">    ObjectName membershipOName =</span>
        new ObjectName(serverName + &quot;:type=ClusterMembership,host=&quot; + hostName);
<span class="nc" id="L47">    ObjectName receiverOName =</span>
        new ObjectName(serverName + &quot;:type=ClusterReceiver,host=&quot; + hostName);
<span class="nc" id="L49">    ObjectName senderOName = new ObjectName(serverName + &quot;:type=ClusterSender,host=&quot; + hostName);</span>

    /*
     * should be just one set, this is just to find out if this instance is cluster-enabled and the
     * cluster supports JMX
     */
<span class="nc" id="L55">    Set&lt;ObjectInstance&gt; clusters =</span>
<span class="nc" id="L56">        mbeanServer.queryMBeans(new ObjectName(&quot;*:type=Cluster,host=&quot; + hostName), null);</span>
<span class="nc" id="L57">    Set&lt;ObjectInstance&gt; membership = mbeanServer.queryMBeans(membershipOName, null);</span>
<span class="nc bnc" id="L58" title="All 8 branches missed.">    if (clusters != null &amp;&amp; !clusters.isEmpty() &amp;&amp; membership != null &amp;&amp; !membership.isEmpty()) {</span>
<span class="nc" id="L59">      ObjectName clusterOName = clusters.iterator().next().getObjectName();</span>
<span class="nc" id="L60">      cluster = new Cluster();</span>

<span class="nc" id="L62">      cluster.setName(JmxTools.getStringAttr(mbeanServer, clusterOName, &quot;clusterName&quot;));</span>
<span class="nc" id="L63">      cluster.setInfo(JmxTools.getStringAttr(mbeanServer, clusterOName, &quot;info&quot;));</span>
<span class="nc" id="L64">      cluster.setManagerClassName(</span>
<span class="nc" id="L65">          JmxTools.getStringAttr(mbeanServer, clusterOName, &quot;managerClassName&quot;));</span>

<span class="nc" id="L67">      cluster.setMcastAddress(JmxTools.getStringAttr(mbeanServer, membershipOName, &quot;mcastAddr&quot;));</span>
<span class="nc" id="L68">      cluster.setMcastBindAddress(</span>
<span class="nc" id="L69">          JmxTools.getStringAttr(mbeanServer, membershipOName, &quot;mcastBindAddress&quot;));</span>
<span class="nc" id="L70">      cluster.setMcastClusterDomain(</span>
<span class="nc" id="L71">          JmxTools.getStringAttr(mbeanServer, membershipOName, &quot;mcastClusterDomain&quot;));</span>
<span class="nc" id="L72">      cluster.setMcastDropTime(JmxTools.getLongAttr(mbeanServer, membershipOName, &quot;mcastDropTime&quot;));</span>
<span class="nc" id="L73">      cluster</span>
<span class="nc" id="L74">          .setMcastFrequency(JmxTools.getLongAttr(mbeanServer, membershipOName, &quot;mcastFrequency&quot;));</span>
<span class="nc" id="L75">      cluster.setMcastPort(JmxTools.getIntAttr(mbeanServer, membershipOName, &quot;mcastPort&quot;));</span>
<span class="nc" id="L76">      cluster</span>
<span class="nc" id="L77">          .setMcastSoTimeout(JmxTools.getIntAttr(mbeanServer, membershipOName, &quot;mcastSoTimeout&quot;));</span>
<span class="nc" id="L78">      cluster.setMcastTtl(JmxTools.getIntAttr(mbeanServer, membershipOName, &quot;mcastTTL&quot;));</span>

<span class="nc" id="L80">      cluster.setTcpListenAddress(</span>
<span class="nc" id="L81">          JmxTools.getStringAttr(mbeanServer, receiverOName, &quot;tcpListenAddress&quot;));</span>
<span class="nc" id="L82">      cluster.setTcpListenPort(JmxTools.getIntAttr(mbeanServer, receiverOName, &quot;tcpListenPort&quot;));</span>
<span class="nc" id="L83">      cluster.setNrOfMsgsReceived(</span>
<span class="nc" id="L84">          JmxTools.getLongAttr(mbeanServer, receiverOName, &quot;nrOfMsgsReceived&quot;));</span>
<span class="nc" id="L85">      cluster.setTotalReceivedBytes(</span>
<span class="nc" id="L86">          JmxTools.getLongAttr(mbeanServer, receiverOName, &quot;totalReceivedBytes&quot;));</span>
      // cluster.setTcpSelectorTimeout(
      // JmxTools.getLongAttr(mbeanServer, receiverOName, &quot;tcpSelectorTimeout&quot;));
      // cluster.setTcpThreadCount(
      // JmxTools.getIntAttr(mbeanServer, receiverOName, &quot;tcpThreadCount&quot;));

<span class="nc" id="L92">      cluster.setSenderAckTimeout(JmxTools.getLongAttr(mbeanServer, senderOName, &quot;ackTimeout&quot;));</span>
<span class="nc" id="L93">      cluster.setSenderAutoConnect((Boolean) mbeanServer.getAttribute(senderOName, &quot;autoConnect&quot;));</span>
<span class="nc" id="L94">      cluster.setSenderFailureCounter(</span>
<span class="nc" id="L95">          JmxTools.getLongAttr(mbeanServer, senderOName, &quot;failureCounter&quot;));</span>
<span class="nc" id="L96">      cluster.setSenderNrOfRequests(JmxTools.getLongAttr(mbeanServer, senderOName, &quot;nrOfRequests&quot;));</span>
<span class="nc" id="L97">      cluster.setSenderReplicationMode(</span>
<span class="nc" id="L98">          JmxTools.getStringAttr(mbeanServer, senderOName, &quot;replicationMode&quot;));</span>
<span class="nc" id="L99">      cluster.setSenderTotalBytes(JmxTools.getLongAttr(mbeanServer, senderOName, &quot;totalBytes&quot;));</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">      if (loadMembers) {</span>
<span class="nc" id="L102">        ObjectName[] senders =</span>
<span class="nc" id="L103">            (ObjectName[]) mbeanServer.getAttribute(senderOName, &quot;senderObjectNames&quot;);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        for (ObjectName localSenderOName : senders) {</span>
          ClusterSender sender;

<span class="nc bnc" id="L107" title="All 2 branches missed.">          if (&quot;pooled&quot;.equals(cluster.getSenderReplicationMode())) {</span>
<span class="nc" id="L108">            sender = new PooledClusterSender();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">          } else if (&quot;synchronous&quot;.equals(cluster.getSenderReplicationMode())) {</span>
<span class="nc" id="L110">            sender = new SyncClusterSender();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">          } else if (&quot;asynchronous&quot;.equals(cluster.getSenderReplicationMode())</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">              || &quot;fastasyncqueue&quot;.equals(cluster.getSenderReplicationMode())) {</span>
<span class="nc" id="L113">            sender = new AsyncClusterSender();</span>
          } else {
<span class="nc" id="L115">            sender = new ClusterSender();</span>
          }

<span class="nc" id="L118">          sender.setAddress(JmxTools.getStringAttr(mbeanServer, localSenderOName, &quot;address&quot;));</span>
<span class="nc" id="L119">          sender.setPort(JmxTools.getIntAttr(mbeanServer, localSenderOName, &quot;port&quot;));</span>

<span class="nc" id="L121">          sender.setAvgMessageSize(</span>
<span class="nc" id="L122">              JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;avgMessageSize&quot;, -1));</span>
<span class="nc" id="L123">          sender.setAvgProcessingTime(</span>
<span class="nc" id="L124">              JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;avgProcessingTime&quot;, -1));</span>

<span class="nc" id="L126">          sender.setConnectCounter(</span>
<span class="nc" id="L127">              JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;connectCounter&quot;));</span>
<span class="nc" id="L128">          sender.setDisconnectCounter(</span>
<span class="nc" id="L129">              JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;disconnectCounter&quot;));</span>
<span class="nc" id="L130">          sender.setConnected((Boolean) mbeanServer.getAttribute(localSenderOName, &quot;connected&quot;));</span>
<span class="nc" id="L131">          sender.setKeepAliveTimeout(</span>
<span class="nc" id="L132">              JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;keepAliveTimeout&quot;));</span>
<span class="nc" id="L133">          sender</span>
<span class="nc" id="L134">              .setNrOfRequests(JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;nrOfRequests&quot;));</span>
<span class="nc" id="L135">          sender.setTotalBytes(JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;totalBytes&quot;));</span>
<span class="nc" id="L136">          sender.setResend((Boolean) mbeanServer.getAttribute(localSenderOName, &quot;resend&quot;));</span>
<span class="nc" id="L137">          sender.setSuspect((Boolean) mbeanServer.getAttribute(localSenderOName, &quot;suspect&quot;));</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">          if (sender instanceof PooledClusterSender) {</span>
<span class="nc" id="L140">            ((PooledClusterSender) sender).setMaxPoolSocketLimit(</span>
<span class="nc" id="L141">                JmxTools.getIntAttr(mbeanServer, localSenderOName, &quot;maxPoolSocketLimit&quot;));</span>
          }

<span class="nc bnc" id="L144" title="All 2 branches missed.">          if (sender instanceof SyncClusterSender) {</span>
<span class="nc" id="L145">            SyncClusterSender syncSender = (SyncClusterSender) sender;</span>
<span class="nc" id="L146">            syncSender.setDataFailureCounter(</span>
<span class="nc" id="L147">                JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;dataFailureCounter&quot;));</span>
<span class="nc" id="L148">            syncSender.setDataResendCounter(</span>
<span class="nc" id="L149">                JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;dataResendCounter&quot;));</span>
<span class="nc" id="L150">            syncSender.setSocketOpenCounter(</span>
<span class="nc" id="L151">                JmxTools.getIntAttr(mbeanServer, localSenderOName, &quot;socketOpenCounter&quot;));</span>
<span class="nc" id="L152">            syncSender.setSocketCloseCounter(</span>
<span class="nc" id="L153">                JmxTools.getIntAttr(mbeanServer, localSenderOName, &quot;socketCloseCounter&quot;));</span>
<span class="nc" id="L154">            syncSender.setSocketOpenFailureCounter(</span>
<span class="nc" id="L155">                JmxTools.getIntAttr(mbeanServer, localSenderOName, &quot;socketOpenFailureCounter&quot;));</span>
          }

<span class="nc bnc" id="L158" title="All 2 branches missed.">          if (sender instanceof AsyncClusterSender) {</span>
<span class="nc" id="L159">            AsyncClusterSender asyncSender = (AsyncClusterSender) sender;</span>
<span class="nc" id="L160">            asyncSender.setInQueueCounter(</span>
<span class="nc" id="L161">                JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;inQueueCounter&quot;));</span>
<span class="nc" id="L162">            asyncSender.setOutQueueCounter(</span>
<span class="nc" id="L163">                JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;outQueueCounter&quot;));</span>
<span class="nc" id="L164">            asyncSender</span>
<span class="nc" id="L165">                .setQueueSize(JmxTools.getIntAttr(mbeanServer, localSenderOName, &quot;queueSize&quot;));</span>
<span class="nc" id="L166">            asyncSender.setQueuedNrOfBytes(</span>
<span class="nc" id="L167">                JmxTools.getLongAttr(mbeanServer, localSenderOName, &quot;queuedNrOfBytes&quot;));</span>
          }
<span class="nc" id="L169">          cluster.getMembers().add(sender);</span>
        }
      }
    }
<span class="nc" id="L173">    return cluster;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>