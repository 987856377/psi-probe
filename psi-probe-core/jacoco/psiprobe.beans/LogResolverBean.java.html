<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogResolverBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.beans</a> &gt; <span class="el_source">LogResolverBean.java</span></div><h1>LogResolverBean.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.beans;

import java.io.File;
import java.io.Serializable;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import javax.inject.Inject;
import javax.servlet.ServletContext;
import org.apache.catalina.Context;
import org.apache.catalina.Loader;
import org.apache.commons.lang3.reflect.MethodUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.ClassUtils;
import psiprobe.model.Application;
import psiprobe.model.DisconnectedLogDestination;
import psiprobe.tools.ApplicationUtils;
import psiprobe.tools.Instruments;
import psiprobe.tools.logging.FileLogAccessor;
import psiprobe.tools.logging.LogDestination;
import psiprobe.tools.logging.catalina.CatalinaLoggerAccessor;
import psiprobe.tools.logging.commons.CommonsLoggerAccessor;
import psiprobe.tools.logging.jdk.Jdk14LoggerAccessor;
import psiprobe.tools.logging.jdk.Jdk14ManagerAccessor;
import psiprobe.tools.logging.log4j.Log4JLoggerAccessor;
import psiprobe.tools.logging.log4j.Log4JManagerAccessor;
import psiprobe.tools.logging.log4j2.Log4J2AppenderAccessor;
import psiprobe.tools.logging.log4j2.Log4J2LoggerConfigAccessor;
import psiprobe.tools.logging.log4j2.Log4J2LoggerContextAccessor;
import psiprobe.tools.logging.log4j2.Log4J2WebLoggerContextUtilsAccessor;
import psiprobe.tools.logging.logback.LogbackFactoryAccessor;
import psiprobe.tools.logging.logback.LogbackLoggerAccessor;
import psiprobe.tools.logging.slf4jlogback.TomcatSlf4jLogbackFactoryAccessor;
import psiprobe.tools.logging.slf4jlogback.TomcatSlf4jLogbackLoggerAccessor;

/**
 * The Class LogResolverBean.
 */
<span class="fc" id="L56">public class LogResolverBean {</span>

  /** The Constant logger. */
<span class="fc" id="L59">  private static final Logger logger = LoggerFactory.getLogger(LogResolverBean.class);</span>

  /** The container wrapper. */
  @Inject
  private ContainerWrapperBean containerWrapper;

  /** The stdout files. */
<span class="fc" id="L66">  private List&lt;String&gt; stdoutFiles = new ArrayList&lt;&gt;();</span>

  /**
   * Gets the container wrapper.
   *
   * @return the container wrapper
   */
  public ContainerWrapperBean getContainerWrapper() {
<span class="nc" id="L74">    return containerWrapper;</span>
  }

  /**
   * Sets the container wrapper.
   *
   * @param containerWrapper the new container wrapper
   */
  public void setContainerWrapper(ContainerWrapperBean containerWrapper) {
<span class="nc" id="L83">    this.containerWrapper = containerWrapper;</span>
<span class="nc" id="L84">  }</span>

  /**
   * Gets the stdout files.
   *
   * @return the stdout files
   */
  public List&lt;String&gt; getStdoutFiles() {
<span class="nc" id="L92">    return stdoutFiles;</span>
  }

  /**
   * Sets the stdout files.
   *
   * @param stdoutFiles the new stdout files
   */
  @Autowired
  public void setStdoutFiles(List&lt;String&gt; stdoutFiles) {
<span class="fc" id="L102">    logger.info(&quot;stdoutFiles {}&quot;, stdoutFiles);</span>
<span class="fc" id="L103">    this.stdoutFiles = stdoutFiles;</span>
<span class="fc" id="L104">  }</span>

  /**
   * Gets the log destinations.
   *
   * @param all the all
   * @return the log destinations
   */
  public List&lt;LogDestination&gt; getLogDestinations(boolean all) {
<span class="nc" id="L113">    List&lt;LogDestination&gt; allAppenders = getAllLogDestinations();</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">    if (allAppenders == null) {</span>
<span class="nc" id="L116">      return null;</span>
    }

    //
    // this list has to guarantee the order in which elements are added
    //
<span class="nc" id="L122">    List&lt;LogDestination&gt; uniqueList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L123">    AbstractLogComparator cmp = new LogDestinationComparator(all);</span>

<span class="nc" id="L125">    Collections.sort(allAppenders, cmp);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">    for (LogDestination dest : allAppenders) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">      if (Collections.binarySearch(uniqueList, dest, cmp) &lt; 0) {</span>
<span class="nc bnc" id="L128" title="All 6 branches missed.">        if (all || dest.getFile() == null || dest.getFile().exists()) {</span>
<span class="nc" id="L129">          uniqueList.add(new DisconnectedLogDestination().builder(dest));</span>
        }
      }
<span class="nc" id="L132">    }</span>
<span class="nc" id="L133">    return uniqueList;</span>
  }

  /**
   * Gets the log sources.
   *
   * @param logFile the log file
   * @return the log sources
   */
  public List&lt;LogDestination&gt; getLogSources(File logFile) {
<span class="nc" id="L143">    List&lt;LogDestination&gt; filtered = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L144">    List&lt;LogDestination&gt; sources = getLogSources();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    for (LogDestination dest : sources) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">      if (logFile.equals(dest.getFile())) {</span>
<span class="nc" id="L147">        filtered.add(dest);</span>
      }
<span class="nc" id="L149">    }</span>
<span class="nc" id="L150">    return filtered;</span>
  }

  /**
   * Gets the log sources.
   *
   * @return the log sources
   */
  public List&lt;LogDestination&gt; getLogSources() {
<span class="nc" id="L159">    List&lt;LogDestination&gt; sources = new LinkedList&lt;&gt;();</span>

<span class="nc" id="L161">    List&lt;LogDestination&gt; allAppenders = getAllLogDestinations();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">    if (allAppenders != null) {</span>
<span class="nc" id="L163">      AbstractLogComparator cmp = new LogSourceComparator();</span>

<span class="nc" id="L165">      Collections.sort(allAppenders, cmp);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">      for (LogDestination dest : allAppenders) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (Collections.binarySearch(sources, dest, cmp) &lt; 0) {</span>
<span class="nc" id="L168">          sources.add(new DisconnectedLogDestination().builder(dest));</span>
        }
<span class="nc" id="L170">      }</span>
    }
<span class="nc" id="L172">    return sources;</span>
  }

  /**
   * Gets the all log destinations.
   *
   * @return the all log destinations
   */
  private List&lt;LogDestination&gt; getAllLogDestinations() {
<span class="nc bnc" id="L181" title="All 2 branches missed.">    if (!Instruments.isInitialized()) {</span>
<span class="nc" id="L182">      return null;</span>
    }

<span class="nc" id="L185">    List&lt;LogDestination&gt; allAppenders = new ArrayList&lt;&gt;();</span>

    //
    // interrogate classloader hierarchy
    //
<span class="nc" id="L190">    ClassLoader cl2 = Thread.currentThread().getContextClassLoader().getParent();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">    while (cl2 != null) {</span>
<span class="nc" id="L192">      interrogateClassLoader(cl2, null, allAppenders);</span>
<span class="nc" id="L193">      cl2 = cl2.getParent();</span>
    }

    //
    // check for known stdout files, such as &quot;catalina.out&quot;
    //
<span class="nc" id="L199">    interrogateStdOutFiles(allAppenders);</span>

    //
    // interrogate webapp classloaders and available loggers
    //
<span class="nc" id="L204">    List&lt;Context&gt; contexts = getContainerWrapper().getTomcatContainer().findContexts();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">    for (Context ctx : contexts) {</span>
<span class="nc" id="L206">      interrogateContext(ctx, allAppenders);</span>
<span class="nc" id="L207">    }</span>

<span class="nc" id="L209">    return allAppenders;</span>
  }

  /**
   * Gets the log destination.
   *
   * @param logType the log type
   * @param webapp the webapp
   * @param context the context
   * @param root the root
   * @param logName the log name
   * @param logIndex the log index
   * @return the log destination
   */
  public LogDestination getLogDestination(String logType, String webapp, boolean context,
      boolean root, String logName, String logIndex) {

<span class="nc" id="L226">    LogDestination result = null;</span>
<span class="nc" id="L227">    Context ctx = null;</span>
<span class="nc" id="L228">    Application application = null;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">    if (webapp != null) {</span>
<span class="nc" id="L230">      ctx = getContainerWrapper().getTomcatContainer().findContext(webapp);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">      if (ctx != null) {</span>
<span class="nc" id="L232">        application = ApplicationUtils.getApplication(ctx, getContainerWrapper());</span>
      }
    }

<span class="nc bnc" id="L236" title="All 4 branches missed.">    if (logName != null &amp;&amp; &quot;stdout&quot;.equals(logType)) {</span>
<span class="nc" id="L237">      result = getStdoutLogDestination(logName);</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">    } else if (ctx != null &amp;&amp; &quot;catalina&quot;.equals(logType)) {</span>
<span class="nc" id="L239">      result = getCatalinaLogDestination(ctx, application);</span>
<span class="nc bnc" id="L240" title="All 6 branches missed.">    } else if (logIndex != null &amp;&amp; (&quot;jdk&quot;.equals(logType) || &quot;log4j&quot;.equals(logType)</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">        || &quot;log4j2&quot;.equals(logType) || &quot;logback&quot;.equals(logType))</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        || &quot;tomcatSlf4jLogback&quot;.equals(logType)) {</span>
<span class="nc bnc" id="L243" title="All 6 branches missed.">      if (context &amp;&amp; ctx != null &amp;&amp; !&quot;log4j2&quot;.equals(logType)) {</span>
<span class="nc" id="L244">        result = getCommonsLogDestination(ctx, application, logIndex);</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">      } else if (ctx != null &amp;&amp; &quot;log4j2&quot;.equals(logType)) {</span>
<span class="nc" id="L246">        result = getLog4J2LogDestination(ctx, application, root, logName, logIndex);</span>
      } else {
        ClassLoader cl;
<span class="nc" id="L249">        ClassLoader prevCl = null;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (ctx != null) {</span>
<span class="nc" id="L251">          cl = ctx.getLoader().getClassLoader();</span>
<span class="nc" id="L252">          prevCl = ClassUtils.overrideThreadContextClassLoader(cl);</span>
        } else {
<span class="nc" id="L254">          cl = Thread.currentThread().getContextClassLoader().getParent();</span>
        }
        try {
<span class="nc bnc" id="L257" title="All 6 branches missed.">          if ((root || logName != null) &amp;&amp; logIndex != null) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (&quot;jdk&quot;.equals(logType)) {</span>
<span class="nc" id="L259">              result = getJdk14LogDestination(cl, application, root, logName, logIndex);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            } else if (&quot;log4j&quot;.equals(logType)) {</span>
<span class="nc" id="L261">              result = getLog4JLogDestination(cl, application, root, logName, logIndex);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            } else if (&quot;logback&quot;.equals(logType)) {</span>
<span class="nc" id="L263">              result = getLogbackLogDestination(cl, application, root, logName, logIndex);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            } else if (&quot;tomcatSlf4jLogback&quot;.equals(logType)) {</span>
<span class="nc" id="L265">              result = getLogbackTomcatJuliLogDestination(cl, application, root, logName, logIndex);</span>
            }
          }
        } finally {
<span class="nc bnc" id="L269" title="All 2 branches missed.">          if (prevCl != null) {</span>
<span class="nc" id="L270">            ClassUtils.overrideThreadContextClassLoader(prevCl);</span>
          }
        }
      }
    }
<span class="nc" id="L275">    return result;</span>
  }

  /**
   * Interrogate context.
   *
   * @param ctx the ctx
   * @param allAppenders the all appenders
   */
  private void interrogateContext(Context ctx, List&lt;LogDestination&gt; allAppenders) {
<span class="nc" id="L285">    Application application = ApplicationUtils.getApplication(ctx, getContainerWrapper());</span>
<span class="nc" id="L286">    ClassLoader cl = ctx.getLoader().getClassLoader();</span>
<span class="nc" id="L287">    Object contextLogger = ctx.getLogger();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">    if (contextLogger != null) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">      if (contextLogger.getClass().getName().startsWith(&quot;org.apache.commons.logging&quot;)) {</span>
<span class="nc" id="L290">        CommonsLoggerAccessor commonsAccessor = new CommonsLoggerAccessor();</span>
<span class="nc" id="L291">        commonsAccessor.setTarget(contextLogger);</span>
<span class="nc" id="L292">        commonsAccessor.setApplication(application);</span>
<span class="nc" id="L293">        allAppenders.addAll(commonsAccessor.getDestinations());</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">      } else if (contextLogger.getClass().getName().startsWith(&quot;org.apache.catalina.logger&quot;)) {</span>
<span class="nc" id="L295">        CatalinaLoggerAccessor catalinaAccessor = new CatalinaLoggerAccessor();</span>
<span class="nc" id="L296">        catalinaAccessor.setApplication(application);</span>
<span class="nc" id="L297">        catalinaAccessor.setTarget(contextLogger);</span>
<span class="nc" id="L298">        allAppenders.add(catalinaAccessor);</span>
      }

<span class="nc" id="L301">      ServletContext servletContext = ctx.getServletContext();</span>
      try {
<span class="nc" id="L303">        Log4J2LoggerContextAccessor loggerContextAccessor = null;</span>
        try {
<span class="nc" id="L305">          Log4J2WebLoggerContextUtilsAccessor webLoggerContextUtilsAccessor =</span>
              new Log4J2WebLoggerContextUtilsAccessor(cl);
<span class="nc" id="L307">          loggerContextAccessor = webLoggerContextUtilsAccessor.getWebLoggerContext(servletContext);</span>
<span class="nc" id="L308">        } catch (Exception e) {</span>
<span class="nc" id="L309">          logger.debug(&quot;Log4J2LoggerContextAccessor instantiation failed&quot;, e);</span>
<span class="nc" id="L310">        }</span>
<span class="nc" id="L311">        List&lt;Object&gt; loggerContexts = getLoggerContexts(cl);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        for (Object loggerContext : loggerContexts) {</span>
<span class="nc" id="L313">          Map&lt;String, Object&gt; loggerConfigs = getLoggerConfigs(loggerContext);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">          for (Object loggerConfig : loggerConfigs.values()) {</span>
<span class="nc" id="L315">            Log4J2LoggerConfigAccessor logConfigAccessor = new Log4J2LoggerConfigAccessor();</span>
<span class="nc" id="L316">            logConfigAccessor.setTarget(loggerConfig);</span>
<span class="nc" id="L317">            logConfigAccessor.setApplication(application);</span>
<span class="nc" id="L318">            logConfigAccessor.setContext(true);</span>
<span class="nc" id="L319">            logConfigAccessor.setLoggerContext(loggerContextAccessor);</span>
<span class="nc" id="L320">            Method getAppenders =</span>
<span class="nc" id="L321">                MethodUtils.getAccessibleMethod(loggerConfig.getClass(), &quot;getAppenders&quot;);</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L323">            Map&lt;String, Object&gt; appenders = (Map&lt;String, Object&gt;) getAppenders.invoke(loggerConfig);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            for (Object appender : appenders.values()) {</span>
<span class="nc" id="L325">              Log4J2AppenderAccessor appenderAccessor = new Log4J2AppenderAccessor();</span>
<span class="nc" id="L326">              appenderAccessor.setTarget(appender);</span>
<span class="nc" id="L327">              appenderAccessor.setLoggerAccessor(logConfigAccessor);</span>
<span class="nc" id="L328">              appenderAccessor.setApplication(application);</span>
<span class="nc" id="L329">              allAppenders.add(appenderAccessor);</span>
<span class="nc" id="L330">            }</span>
<span class="nc" id="L331">          }</span>
<span class="nc" id="L332">        }</span>
<span class="nc" id="L333">      } catch (Exception e) {</span>
<span class="nc" id="L334">        logger.debug(&quot;getting appenders failed&quot;, e);</span>
<span class="nc" id="L335">      }</span>
    }

<span class="nc bnc" id="L338" title="All 2 branches missed.">    if (application.isAvailable()) {</span>
<span class="nc" id="L339">      ClassLoader prevCl = ClassUtils.overrideThreadContextClassLoader(cl);</span>
      try {
<span class="nc" id="L341">        interrogateClassLoader(cl, application, allAppenders);</span>
<span class="nc" id="L342">      } catch (Exception e) {</span>
<span class="nc" id="L343">        logger.error(</span>
            &quot;Could not interrogate classloader loggers for {}. Enable debug logging to see the trace stack&quot;,
<span class="nc" id="L345">            ctx.getName());</span>
<span class="nc" id="L346">        logger.debug(&quot;&quot;, e);</span>
      } finally {
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (prevCl != null) {</span>
<span class="nc" id="L349">          ClassUtils.overrideThreadContextClassLoader(prevCl);</span>
        }
      }
    }
<span class="nc" id="L353">  }</span>

  /**
   * Interrogate class loader.
   *
   * @param cl the cl
   * @param application the application
   * @param appenders the appenders
   */
  private void interrogateClassLoader(ClassLoader cl, Application application,
      List&lt;LogDestination&gt; appenders) {

    String applicationName =
<span class="nc bnc" id="L366" title="All 2 branches missed.">        application != null ? &quot;application \&quot;&quot; + application.getName() + &quot;\&quot;&quot; : &quot;server&quot;;</span>

    // check for JDK loggers
    try {
<span class="nc" id="L370">      Jdk14ManagerAccessor jdk14accessor = new Jdk14ManagerAccessor(cl);</span>
<span class="nc" id="L371">      jdk14accessor.setApplication(application);</span>
<span class="nc" id="L372">      appenders.addAll(jdk14accessor.getHandlers());</span>
<span class="nc" id="L373">    } catch (Exception e) {</span>
<span class="nc" id="L374">      logger.debug(&quot;Could not resolve JDK loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L375">    }</span>

    // check for Log4J loggers
    try {
<span class="nc" id="L379">      Log4JManagerAccessor log4JAccessor = new Log4JManagerAccessor(cl);</span>
<span class="nc" id="L380">      log4JAccessor.setApplication(application);</span>
<span class="nc" id="L381">      appenders.addAll(log4JAccessor.getAppenders());</span>
<span class="nc" id="L382">    } catch (Exception e) {</span>
<span class="nc" id="L383">      logger.debug(&quot;Could not resolve log4j loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L384">    }</span>

    // check for Logback loggers
    try {
<span class="nc" id="L388">      LogbackFactoryAccessor logbackAccessor = new LogbackFactoryAccessor(cl);</span>
<span class="nc" id="L389">      logbackAccessor.setApplication(application);</span>
<span class="nc" id="L390">      appenders.addAll(logbackAccessor.getAppenders());</span>
<span class="nc" id="L391">    } catch (Exception e) {</span>
<span class="nc" id="L392">      logger.debug(&quot;Could not resolve logback loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L393">    }</span>

    // check for tomcat-slf4j-logback loggers
    try {
<span class="nc" id="L397">      TomcatSlf4jLogbackFactoryAccessor tomcatSlf4jLogbackAccessor =</span>
          new TomcatSlf4jLogbackFactoryAccessor(cl);
<span class="nc" id="L399">      tomcatSlf4jLogbackAccessor.setApplication(application);</span>
<span class="nc" id="L400">      appenders.addAll(tomcatSlf4jLogbackAccessor.getAppenders());</span>
<span class="nc" id="L401">    } catch (Exception e) {</span>
<span class="nc" id="L402">      logger.debug(&quot;Could not resolve tomcat-slf4j-logback loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L403">    }</span>
<span class="nc" id="L404">  }</span>

  /**
   * Interrogate std out files.
   *
   * @param appenders the appenders
   */
  private void interrogateStdOutFiles(List&lt;LogDestination&gt; appenders) {
<span class="nc bnc" id="L412" title="All 2 branches missed.">    for (String fileName : stdoutFiles) {</span>
<span class="nc" id="L413">      FileLogAccessor fla = resolveStdoutLogDestination(fileName);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">      if (fla != null) {</span>
<span class="nc" id="L415">        appenders.add(fla);</span>
      }
<span class="nc" id="L417">    }</span>
<span class="nc" id="L418">  }</span>

  /**
   * Gets the stdout log destination.
   *
   * @param logName the log name
   * @return the stdout log destination
   */
  private LogDestination getStdoutLogDestination(String logName) {
<span class="nc bnc" id="L427" title="All 2 branches missed.">    for (String fileName : stdoutFiles) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">      if (fileName.equals(logName)) {</span>
<span class="nc" id="L429">        FileLogAccessor fla = resolveStdoutLogDestination(fileName);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (fla != null) {</span>
<span class="nc" id="L431">          return fla;</span>
        }
      }
<span class="nc" id="L434">    }</span>
<span class="nc" id="L435">    return null;</span>
  }

  /**
   * Resolve stdout log destination.
   *
   * @param fileName the file name
   * @return the file log accessor
   */
  private FileLogAccessor resolveStdoutLogDestination(String fileName) {
<span class="nc" id="L445">    File stdout = new File(System.getProperty(&quot;catalina.base&quot;), &quot;logs/&quot; + fileName);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">    if (stdout.exists()) {</span>
<span class="nc" id="L447">      FileLogAccessor fla = new FileLogAccessor();</span>
<span class="nc" id="L448">      fla.setName(fileName);</span>
<span class="nc" id="L449">      fla.setFile(stdout);</span>
<span class="nc" id="L450">      return fla;</span>
    }
<span class="nc" id="L452">    return null;</span>
  }

  /**
   * Gets the catalina log destination.
   *
   * @param ctx the ctx
   * @param application the application
   * @return the catalina log destination
   */
  private LogDestination getCatalinaLogDestination(Context ctx, Application application) {
<span class="nc" id="L463">    Object log = ctx.getLogger();</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">    if (log != null) {</span>
<span class="nc" id="L465">      CatalinaLoggerAccessor logAccessor = new CatalinaLoggerAccessor();</span>
<span class="nc" id="L466">      logAccessor.setTarget(log);</span>
<span class="nc" id="L467">      logAccessor.setApplication(application);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">      if (logAccessor.getFile().exists()) {</span>
<span class="nc" id="L469">        return logAccessor;</span>
      }
    }
<span class="nc" id="L472">    return null;</span>
  }

  /**
   * Gets the commons log destination.
   *
   * @param ctx the ctx
   * @param application the application
   * @param logIndex the log index
   * @return the commons log destination
   */
  private LogDestination getCommonsLogDestination(Context ctx, Application application,
      String logIndex) {
<span class="nc" id="L485">    Object contextLogger = ctx.getLogger();</span>
<span class="nc" id="L486">    CommonsLoggerAccessor commonsAccessor = new CommonsLoggerAccessor();</span>
<span class="nc" id="L487">    commonsAccessor.setTarget(contextLogger);</span>
<span class="nc" id="L488">    commonsAccessor.setApplication(application);</span>
<span class="nc" id="L489">    return commonsAccessor.getDestination(logIndex);</span>
  }

  /**
   * Gets the jdk14 log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param handlerIndex the handler index
   * @return the jdk14 log destination
   */
  private LogDestination getJdk14LogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String handlerIndex) {

    try {
<span class="nc" id="L506">      Jdk14ManagerAccessor manager = new Jdk14ManagerAccessor(cl);</span>
<span class="nc" id="L507">      manager.setApplication(application);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">      Jdk14LoggerAccessor log = root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L510">        return log.getHandler(handlerIndex);</span>
      }
<span class="nc" id="L512">    } catch (Exception e) {</span>
<span class="nc" id="L513">      logger.debug(&quot;getJdk14LogDestination failed&quot;, e);</span>
<span class="nc" id="L514">    }</span>
<span class="nc" id="L515">    return null;</span>
  }

  /**
   * Gets the log4j log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the log4j log destination
   */
  private LogDestination getLog4JLogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String appenderName) {

    try {
<span class="nc" id="L532">      Log4JManagerAccessor manager = new Log4JManagerAccessor(cl);</span>
<span class="nc" id="L533">      manager.setApplication(application);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">      Log4JLoggerAccessor log = root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L536">        return log.getAppender(appenderName);</span>
      }
<span class="nc" id="L538">    } catch (Exception e) {</span>
<span class="nc" id="L539">      logger.debug(&quot;getLog4JLogDestination failed&quot;, e);</span>
<span class="nc" id="L540">    }</span>
<span class="nc" id="L541">    return null;</span>
  }

  /**
   * Gets the log4j2 log destination.
   *
   * @param ctx the ctx
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the log4j2 log destination
   */
  private LogDestination getLog4J2LogDestination(Context ctx, Application application, boolean root,
      String logName, String appenderName) {

<span class="nc" id="L557">    Log4J2AppenderAccessor result = null;</span>
    try {
<span class="nc" id="L559">      Loader loader = ctx.getLoader();</span>
<span class="nc" id="L560">      ClassLoader classLoader = loader.getClassLoader();</span>
<span class="nc" id="L561">      Log4J2WebLoggerContextUtilsAccessor webLoggerContextUtilsAccessor =</span>
          new Log4J2WebLoggerContextUtilsAccessor(classLoader);
<span class="nc" id="L563">      Log4J2LoggerContextAccessor loggerContextAccessor =</span>
<span class="nc" id="L564">          webLoggerContextUtilsAccessor.getWebLoggerContext(ctx.getServletContext());</span>
<span class="nc" id="L565">      List&lt;Object&gt; loggerContexts = getLoggerContexts(classLoader);</span>
<span class="nc" id="L566">      Object loggerConfig = null;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">      for (Object loggerContext : loggerContexts) {</span>
<span class="nc" id="L568">        Map&lt;String, Object&gt; loggerConfigs = getLoggerConfigs(loggerContext);</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">        loggerConfig = loggerConfigs.get(root ? &quot;&quot; : logName);</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (loggerConfig != null) {</span>
<span class="nc" id="L571">          break;</span>
        }
<span class="nc" id="L573">      }</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">      if (loggerConfig != null) {</span>
<span class="nc" id="L575">        Log4J2LoggerConfigAccessor accessor = new Log4J2LoggerConfigAccessor();</span>
<span class="nc" id="L576">        accessor.setTarget(loggerConfig);</span>
<span class="nc" id="L577">        accessor.setApplication(application);</span>
<span class="nc" id="L578">        accessor.setContext(true);</span>
<span class="nc" id="L579">        accessor.setLoggerContext(loggerContextAccessor);</span>
<span class="nc" id="L580">        result = accessor.getAppender(appenderName);</span>
      }
<span class="nc" id="L582">    } catch (Exception e) {</span>
<span class="nc" id="L583">      logger.debug(&quot;getLog4J2LogDestination failed&quot;, e);</span>
<span class="nc" id="L584">    }</span>
<span class="nc" id="L585">    logger.debug(&quot;getLog4J2LogDestination(): OUT: result={}&quot;, result);</span>

<span class="nc" id="L587">    return result;</span>
  }

  private Map&lt;String, Object&gt; getLoggerConfigs(Object loggerContext)
      throws IllegalAccessException, InvocationTargetException {
<span class="nc" id="L592">    Method getConfiguration =</span>
<span class="nc" id="L593">        MethodUtils.getAccessibleMethod(loggerContext.getClass(), &quot;getConfiguration&quot;);</span>
<span class="nc" id="L594">    Object configuration = getConfiguration.invoke(loggerContext);</span>
<span class="nc" id="L595">    Method getLoggerConfigs =</span>
<span class="nc" id="L596">        MethodUtils.getAccessibleMethod(configuration.getClass(), &quot;getLoggers&quot;);</span>
<span class="nc" id="L597">    return (Map&lt;String, Object&gt;) getLoggerConfigs.invoke(configuration);</span>
  }

  private List&lt;Object&gt; getLoggerContexts(ClassLoader cl) throws ClassNotFoundException,
      InstantiationException, IllegalAccessException, InvocationTargetException,
      IllegalArgumentException, NoSuchMethodException, SecurityException {
<span class="nc" id="L603">    Class&lt;?&gt; clazz =</span>
<span class="nc" id="L604">        cl.loadClass(&quot;org.apache.logging.log4j.core.selector.ClassLoaderContextSelector&quot;);</span>
<span class="nc" id="L605">    Object classLoaderContextSelector = clazz.getDeclaredConstructor().newInstance();</span>
<span class="nc" id="L606">    Method getLoggerContexts = MethodUtils.getAccessibleMethod(clazz, &quot;getLoggerContexts&quot;);</span>
<span class="nc" id="L607">    return (List&lt;Object&gt;) getLoggerContexts.invoke(classLoaderContextSelector);</span>
  }

  /**
   * Gets the logback log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the logback log destination
   */
  private LogDestination getLogbackLogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String appenderName) {

    try {
<span class="nc" id="L624">      LogbackFactoryAccessor manager = new LogbackFactoryAccessor(cl);</span>
<span class="nc" id="L625">      manager.setApplication(application);</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">      LogbackLoggerAccessor log = root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L628">        return log.getAppender(appenderName);</span>
      }
<span class="nc" id="L630">    } catch (Exception e) {</span>
<span class="nc" id="L631">      logger.debug(&quot;getLogbackLogDestination failed&quot;, e);</span>
<span class="nc" id="L632">    }</span>
<span class="nc" id="L633">    return null;</span>
  }

  /**
   * Gets the logback tomcat juli log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the logback tomcat juli log destination
   */
  private LogDestination getLogbackTomcatJuliLogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String appenderName) {

    try {
<span class="nc" id="L650">      TomcatSlf4jLogbackFactoryAccessor manager = new TomcatSlf4jLogbackFactoryAccessor(cl);</span>
<span class="nc" id="L651">      manager.setApplication(application);</span>
      TomcatSlf4jLogbackLoggerAccessor log =
<span class="nc bnc" id="L653" title="All 2 branches missed.">          root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L655">        return log.getAppender(appenderName);</span>
      }
<span class="nc" id="L657">    } catch (Exception e) {</span>
<span class="nc" id="L658">      logger.debug(&quot;getTomcatSlf4jLogbackLogDestination failed&quot;, e);</span>
<span class="nc" id="L659">    }</span>
<span class="nc" id="L660">    return null;</span>
  }

  /**
   * The Class AbstractLogComparator.
   */
  private abstract static class AbstractLogComparator
      implements Comparator&lt;LogDestination&gt;, Serializable {

    /** The Constant serialVersionUID. */
    private static final long serialVersionUID = 1L;

    /** The Constant DELIM. */
    protected static final char DELIM = '!';

    @Override
    public final int compare(LogDestination o1, LogDestination o2) {
<span class="nc" id="L677">      String name1 = convertToString(o1);</span>
<span class="nc" id="L678">      String name2 = convertToString(o2);</span>
<span class="nc" id="L679">      return name1.compareTo(name2);</span>
    }

    /**
     * Convert to string.
     *
     * @param d1 the d1
     * @return the string
     */
    protected abstract String convertToString(LogDestination d1);

  }

  /**
   * The Class LogDestinationComparator.
   */
  private static class LogDestinationComparator extends AbstractLogComparator
      implements Serializable {

    /** The Constant serialVersionUID. */
    private static final long serialVersionUID = 1L;

    /** The all. */
    private final boolean all;

    /**
     * Instantiates a new log destination comparator.
     *
     * @param all the all
     */
<span class="nc" id="L709">    public LogDestinationComparator(boolean all) {</span>
<span class="nc" id="L710">      this.all = all;</span>
<span class="nc" id="L711">    }</span>

    @Override
    protected String convertToString(LogDestination dest) {
<span class="nc" id="L715">      File file = dest.getFile();</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">      String fileName = file == null ? &quot;&quot; : file.getAbsolutePath();</span>
      String name;
<span class="nc bnc" id="L718" title="All 2 branches missed.">      if (all) {</span>
<span class="nc" id="L719">        Application app = dest.getApplication();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">        String appName = app == null ? Character.toString(DELIM) : app.getName();</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        String context = dest.isContext() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        String root = dest.isRoot() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc" id="L723">        String logType = dest.getLogType();</span>
<span class="nc" id="L724">        name = appName + DELIM + context + DELIM + root + DELIM + logType + DELIM + fileName;</span>
<span class="nc" id="L725">      } else {</span>
<span class="nc" id="L726">        name = fileName;</span>
      }
<span class="nc" id="L728">      return name;</span>
    }

  }

  /**
   * The Class LogSourceComparator.
   */
<span class="nc" id="L736">  private static class LogSourceComparator extends AbstractLogComparator implements Serializable {</span>

    /** The Constant serialVersionUID. */
    private static final long serialVersionUID = 1L;

    @Override
    protected String convertToString(LogDestination dest) {
<span class="nc" id="L743">      File file = dest.getFile();</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">      String fileName = file == null ? &quot;&quot; : file.getAbsolutePath();</span>
<span class="nc" id="L745">      Application app = dest.getApplication();</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">      String appName = app == null ? Character.toString(DELIM) : app.getName();</span>
<span class="nc" id="L747">      String logType = dest.getLogType();</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">      String context = dest.isContext() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">      String root = dest.isRoot() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc" id="L750">      String logName = dest.getName();</span>
<span class="nc" id="L751">      return appName + DELIM + logType + DELIM + context + DELIM + root + DELIM + logName + DELIM</span>
          + fileName;
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>