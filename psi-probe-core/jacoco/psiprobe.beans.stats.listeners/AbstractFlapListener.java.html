<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractFlapListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.beans.stats.listeners</a> &gt; <span class="el_source">AbstractFlapListener.java</span></div><h1>AbstractFlapListener.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.beans.stats.listeners;

import java.util.HashMap;
import java.util.LinkedList;
import psiprobe.Utils;

/**
 * The listener interface for receiving flap events. The class that is interested in processing a
 * flap event implements this interface, and the object created with that class is registered with a
 * component using the component's {@code addFlapListener} method. When the flap event occurs, that
 * object's appropriate method is invoked.
 *
 * @see &lt;a href=&quot;https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/flapping.html&quot;&gt;
 *      Detection and Handling of State Flapping (nagios)&lt;/a&gt;
 */
<span class="fc" id="L26">public abstract class AbstractFlapListener extends AbstractThresholdListener {</span>

  /** The default flap interval. */
  private int defaultFlapInterval;

  /** The default flap start threshold. */
  private float defaultFlapStartThreshold;

  /** The default flap stop threshold. */
  private float defaultFlapStopThreshold;

  /** The default flap low weight. */
  private float defaultFlapLowWeight;

  /** The default flap high weight. */
  private float defaultFlapHighWeight;

  /** The flaps. */
<span class="fc" id="L44">  private final HashMap&lt;String, LinkedList&lt;Boolean&gt;&gt; flaps = new HashMap&lt;&gt;();</span>

  /** The flapping states. */
<span class="fc" id="L47">  private final HashMap&lt;String, Boolean&gt; flappingStates = new HashMap&lt;&gt;();</span>

  /**
   * Flapping started.
   *
   * @param sce the sce
   */
  protected abstract void flappingStarted(StatsCollectionEvent sce);

  /**
   * Above threshold flapping stopped.
   *
   * @param sce the sce
   */
  protected abstract void aboveThresholdFlappingStopped(StatsCollectionEvent sce);

  /**
   * Below threshold flapping stopped.
   *
   * @param sce the sce
   */
  protected abstract void belowThresholdFlappingStopped(StatsCollectionEvent sce);

  /**
   * Above threshold not flapping.
   *
   * @param sce the sce
   */
  protected abstract void aboveThresholdNotFlapping(StatsCollectionEvent sce);

  /**
   * Below threshold not flapping.
   *
   * @param sce the sce
   */
  protected abstract void belowThresholdNotFlapping(StatsCollectionEvent sce);

  @Override
  protected void crossedAboveThreshold(StatsCollectionEvent sce) {
<span class="fc" id="L86">    statsCollected(sce, true, true);</span>
<span class="fc" id="L87">  }</span>

  @Override
  protected void crossedBelowThreshold(StatsCollectionEvent sce) {
<span class="fc" id="L91">    statsCollected(sce, true, false);</span>
<span class="fc" id="L92">  }</span>

  @Override
  protected void remainedAboveThreshold(StatsCollectionEvent sce) {
<span class="fc" id="L96">    statsCollected(sce, false, true);</span>
<span class="fc" id="L97">  }</span>

  @Override
  protected void remainedBelowThreshold(StatsCollectionEvent sce) {
<span class="fc" id="L101">    statsCollected(sce, false, false);</span>
<span class="fc" id="L102">  }</span>

  @Override
  public void reset() {
<span class="fc" id="L106">    flaps.clear();</span>
<span class="fc" id="L107">    flappingStates.clear();</span>
<span class="fc" id="L108">    super.reset();</span>
<span class="fc" id="L109">  }</span>

  /**
   * Stats collected.
   *
   * @param sce the sce
   * @param crossedThreshold the crossed threshold
   * @param above the above
   */
  protected void statsCollected(StatsCollectionEvent sce, boolean crossedThreshold, boolean above) {
<span class="fc" id="L119">    String name = sce.getName();</span>
<span class="fc" id="L120">    boolean flappingStateChanged = checkFlappingStateChanged(name, crossedThreshold);</span>
<span class="fc" id="L121">    boolean flappingState = getFlappingState(name);</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">    if (flappingStateChanged) {</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">      if (flappingState) {</span>
<span class="fc" id="L124">        flappingStarted(sce);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">      } else if (above) {</span>
<span class="fc" id="L126">        aboveThresholdFlappingStopped(sce);</span>
      } else {
<span class="fc" id="L128">        belowThresholdFlappingStopped(sce);</span>
      }
<span class="fc bfc" id="L130" title="All 2 branches covered.">    } else if (crossedThreshold) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">      if (above) {</span>
<span class="fc" id="L132">        aboveThresholdNotFlapping(sce);</span>
      } else {
<span class="fc" id="L134">        belowThresholdNotFlapping(sce);</span>
      }
    }
<span class="fc" id="L137">  }</span>

  /**
   * Check flapping state changed.
   *
   * @param name the name
   * @param crossedThreshold the crossed threshold
   * @return true, if successful
   */
  protected boolean checkFlappingStateChanged(String name, boolean crossedThreshold) {
<span class="fc" id="L147">    addFlap(name, crossedThreshold);</span>
<span class="fc" id="L148">    boolean oldFlappingState = getFlappingState(name);</span>
<span class="fc" id="L149">    float transitionPercent = calculateStateTransitionPercentage(name, oldFlappingState);</span>
    boolean newFlappingState;
<span class="fc bfc" id="L151" title="All 2 branches covered.">    if (oldFlappingState) {</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">      newFlappingState = transitionPercent &lt;= getFlapStopThreshold(name);</span>
    } else {
<span class="fc bfc" id="L154" title="All 2 branches covered.">      newFlappingState = transitionPercent &gt; getFlapStartThreshold(name);</span>
    }
<span class="fc" id="L156">    setFlappingState(name, newFlappingState);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">    return oldFlappingState != newFlappingState;</span>
  }

  /**
   * Calculate state transition percentage.
   *
   * @param name the name
   * @param flapping the flapping
   * @return the float
   */
  protected float calculateStateTransitionPercentage(String name, boolean flapping) {
<span class="fc" id="L168">    int flapInterval = getFlapInterval(name);</span>
<span class="fc" id="L169">    LinkedList&lt;Boolean&gt; list = getFlaps(name);</span>
<span class="fc" id="L170">    float lowWeight = getFlapLowWeight(name);</span>
<span class="fc" id="L171">    float highWeight = getFlapHighWeight(name);</span>
<span class="fc" id="L172">    float weightRange = highWeight - lowWeight;</span>
<span class="fc" id="L173">    float result = 0;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">    for (int i = list.size() - 1; i &gt;= 0; i--) {</span>
<span class="fc" id="L175">      boolean thisFlap = list.get(i);</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">      if (flapping != thisFlap) {</span>
<span class="fc" id="L177">        float weight = lowWeight + (weightRange * i / (flapInterval - 1));</span>
<span class="fc" id="L178">        result += weight;</span>
      }
    }
<span class="fc" id="L181">    return result / flapInterval;</span>
  }

  /**
   * Adds the flap.
   *
   * @param name the name
   * @param flap the flap
   */
  protected void addFlap(String name, boolean flap) {
<span class="fc" id="L191">    int flapInterval = getFlapInterval(name);</span>
<span class="fc" id="L192">    LinkedList&lt;Boolean&gt; list = getFlaps(name);</span>
<span class="fc" id="L193">    Boolean value = flap;</span>
<span class="fc" id="L194">    list.addLast(value);</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">    while (list.size() &gt; flapInterval) {</span>
<span class="fc" id="L196">      list.removeFirst();</span>
    }
<span class="fc" id="L198">  }</span>

  /**
   * Gets the flapping state.
   *
   * @param name the name
   * @return the flapping state
   */
  protected boolean getFlappingState(String name) {
<span class="fc" id="L207">    Boolean flapping = flappingStates.get(name);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">    if (flapping == null) {</span>
<span class="fc" id="L209">      flapping = Boolean.FALSE;</span>
<span class="fc" id="L210">      setFlappingState(name, false);</span>
    }
<span class="fc" id="L212">    return flapping;</span>
  }

  /**
   * Sets the flapping state.
   *
   * @param name the name
   * @param flapping the flapping
   */
  protected void setFlappingState(String name, boolean flapping) {
<span class="fc" id="L222">    flappingStates.put(name, flapping);</span>
<span class="fc" id="L223">  }</span>

  /**
   * Gets the flaps.
   *
   * @param name the name
   * @return the flaps
   */
  protected LinkedList&lt;Boolean&gt; getFlaps(String name) {
<span class="fc" id="L232">    LinkedList&lt;Boolean&gt; list = flaps.get(name);</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">    if (list == null) {</span>
<span class="fc" id="L234">      list = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L235">      flaps.put(name, list);</span>
    }
<span class="fc" id="L237">    return list;</span>
  }

  /**
   * Gets the flap interval.
   *
   * @param name the name
   * @return the flap interval
   */
  protected int getFlapInterval(String name) {
<span class="fc" id="L247">    String interval = getPropertyValue(name, &quot;flapInterval&quot;);</span>
<span class="fc" id="L248">    return Utils.toInt(interval, getDefaultFlapInterval());</span>
  }

  /**
   * Gets the flap start threshold.
   *
   * @param name the name
   * @return the flap start threshold
   */
  protected float getFlapStartThreshold(String name) {
<span class="fc" id="L258">    String startThreshold = getPropertyValue(name, &quot;flapStartThreshold&quot;);</span>
<span class="fc" id="L259">    return Utils.toFloat(startThreshold, getDefaultFlapStartThreshold());</span>
  }

  /**
   * Gets the flap stop threshold.
   *
   * @param name the name
   * @return the flap stop threshold
   */
  protected float getFlapStopThreshold(String name) {
<span class="fc" id="L269">    String stopThreshold = getPropertyValue(name, &quot;flapStopThreshold&quot;);</span>
<span class="fc" id="L270">    return Utils.toFloat(stopThreshold, getDefaultFlapStopThreshold());</span>
  }

  /**
   * Gets the flap low weight.
   *
   * @param name the name
   * @return the flap low weight
   */
  protected float getFlapLowWeight(String name) {
<span class="fc" id="L280">    String lowWeight = getPropertyValue(name, &quot;flapLowWeight&quot;);</span>
<span class="fc" id="L281">    return Utils.toFloat(lowWeight, getDefaultFlapLowWeight());</span>
  }

  /**
   * Gets the flap high weight.
   *
   * @param name the name
   * @return the flap high weight
   */
  protected float getFlapHighWeight(String name) {
<span class="fc" id="L291">    String highWeight = getPropertyValue(name, &quot;flapHighWeight&quot;);</span>
<span class="fc" id="L292">    return Utils.toFloat(highWeight, getDefaultFlapHighWeight());</span>
  }

  /**
   * Gets the default flap interval.
   *
   * @return the default flap interval
   */
  public int getDefaultFlapInterval() {
<span class="fc" id="L301">    return defaultFlapInterval;</span>
  }

  /**
   * Sets the default flap interval.
   *
   * @param defaultFlapInterval the new default flap interval
   */
  public void setDefaultFlapInterval(int defaultFlapInterval) {
<span class="fc" id="L310">    this.defaultFlapInterval = defaultFlapInterval;</span>
<span class="fc" id="L311">  }</span>

  /**
   * Gets the default flap start threshold.
   *
   * @return the default flap start threshold
   */
  public float getDefaultFlapStartThreshold() {
<span class="fc" id="L319">    return defaultFlapStartThreshold;</span>
  }

  /**
   * Sets the default flap start threshold.
   *
   * @param defaultFlapStartThreshold the new default flap start threshold
   */
  public void setDefaultFlapStartThreshold(float defaultFlapStartThreshold) {
<span class="fc" id="L328">    this.defaultFlapStartThreshold = defaultFlapStartThreshold;</span>
<span class="fc" id="L329">  }</span>

  /**
   * Gets the default flap stop threshold.
   *
   * @return the default flap stop threshold
   */
  public float getDefaultFlapStopThreshold() {
<span class="fc" id="L337">    return defaultFlapStopThreshold;</span>
  }

  /**
   * Sets the default flap stop threshold.
   *
   * @param defaultFlapStopThreshold the new default flap stop threshold
   */
  public void setDefaultFlapStopThreshold(float defaultFlapStopThreshold) {
<span class="fc" id="L346">    this.defaultFlapStopThreshold = defaultFlapStopThreshold;</span>
<span class="fc" id="L347">  }</span>

  /**
   * Gets the default flap low weight.
   *
   * @return the default flap low weight
   */
  public float getDefaultFlapLowWeight() {
<span class="fc" id="L355">    return defaultFlapLowWeight;</span>
  }

  /**
   * Sets the default flap low weight.
   *
   * @param defaultFlapLowWeight the new default flap low weight
   */
  public void setDefaultFlapLowWeight(float defaultFlapLowWeight) {
<span class="fc" id="L364">    this.defaultFlapLowWeight = defaultFlapLowWeight;</span>
<span class="fc" id="L365">  }</span>

  /**
   * Gets the default flap high weight.
   *
   * @return the default flap high weight
   */
  public float getDefaultFlapHighWeight() {
<span class="fc" id="L373">    return defaultFlapHighWeight;</span>
  }

  /**
   * Sets the default flap high weight.
   *
   * @param defaultFlapHighWeight the new default flap high weight
   */
  public void setDefaultFlapHighWeight(float defaultFlapHighWeight) {
<span class="fc" id="L382">    this.defaultFlapHighWeight = defaultFlapHighWeight;</span>
<span class="fc" id="L383">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>